<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Gems</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: #0d6efd; /* Bootstrap primary color */
            color: #fff;
            font-weight: bold;
        }
        .table-dark {
            background-color: #343a40;
            color: #fff;
        }
        .table-dark tbody tr:hover {
            background-color: #495057;
        }
        .floating-summary {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #212529;
            color: #fff;
            padding: 20px;
            z-index: 999;
            max-height: 50%;
            overflow-y: auto;
        }
        .floating-summary.show {
            display: block;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container my-4">
        <div class="row">
            <div class="col-md-9">
                <h1 class="mb-4">Kalkulator Gems</h1>
                <div class="mb-4">
                    <div class="btn-group" role="group" aria-label="Tabs">
                        <button type="button" class="tab-button btn btn-primary" data-target="speed-ups">Speed Ups</button>
                        <button type="button" class="tab-button btn btn-primary" data-target="combat">Combat</button>
                        <!-- Add more buttons as needed -->
                    </div>
                </div>
                <div id="tabs-content">
                    <!-- Tab contents will be dynamically loaded here -->
                </div>
            </div>
            <div class="col-md-3">
                <h2 class="mb-4">My Wishlist</h2>
                <table id="summary-table" class="table table-dark">
                    <thead>
                        <tr>
                            <th scope="col">Image</th>
                            <th scope="col">Item</th>
                            <th scope="col">Price</th>
                            <th scope="col">Qty</th>
                            <th scope="col">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Summary rows will be dynamically added here -->
                    </tbody>
                </table>
                <div id="total" class="mt-3">
                    <strong>Total Gems: <span id="total-gems">0</span></strong>
                </div>
                <div id="whatsapp-button" class="mt-3">
                    <!-- WhatsApp button will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
    <div class="floating-summary">
        <h5 class="mb-3">Summary</h5>
        <table id="floating-summary-table" class="table table-dark">
            <thead>
                <tr>
                    <th scope="col">Item</th>
                    <th scope="col">Price</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Floating summary rows will be dynamically added here -->
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            const tabsContent = $('#tabs-content');
            const totalGemsElement = $('#total-gems');
            const summaryTableBody = $('#summary-table tbody');
            const whatsappButtonDiv = $('#whatsapp-button');
            const floatingSummaryTableBody = $('#floating-summary-table tbody');

            let data = {};
            let currentTabId = 'speed-ups'; // Default tab

            function formatNumber(number) {
                return new Intl.NumberFormat('id-ID').format(number);
            }

            function createTable(data) {
                let tableHtml = `
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th scope="col">Image</th>
                                <th scope="col">Item Name</th>
                                <th scope="col">Price</th>
                                <th scope="col">Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td><img src="${item.image}" alt="${item.name}" class="img-thumbnail" style="width: 50px; height: 50px;"></td>
                                    <td>${item.name}</td>
                                    <td>${formatNumber(item.price)} Gems</td>
                                    <td>
                                        <input type="number" class="form-control" data-price="${item.price}" value="0" data-item='${JSON.stringify(item)}'>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                return tableHtml;
            }

            function showTab(targetId) {
                if (!data[targetId]) return;

                // Remove existing tab content
                tabsContent.empty();

                // Create and display new tab content
                const newTabContent = $('<div>', { id: targetId, class: 'tab-content active' });
                newTabContent.html(createTable(data[targetId]));
                tabsContent.append(newTabContent);

                currentTabId = targetId; // Update the current tab
                updateTotalAndSummary();
            }

            function initialize() {
                $('.tab-button').on('click', function() {
                    const targetId = $(this).data('target');
                    showTab(targetId);
                    $('.tab-button').removeClass('active');
                    $(this).addClass('active');
                });

                // Set default tab
                showTab(currentTabId);
                $('.tab-button').each(function() {
                    if ($(this).data('target') === currentTabId) {
                        $(this).addClass('active');
                    }
                });

                // Use event delegation to handle input changes with debounce
                let debounceTimer;
                tabsContent.on('input', 'input[type="number"]', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(updateTotalAndSummary, 300);
                });
            }

            function updateTotalAndSummary() {
                let total = 0;
                summaryTableBody.empty(); // Clear existing summary
                floatingSummaryTableBody.empty(); // Clear floating summary

                // Aggregate items from the current tab only
                const currentTabData = data[currentTabId] || [];
                let message = "Hi, I'd like to purchase the following items:\n\n"; // Message for WhatsApp

                currentTabData.forEach(item => {
                    const input = $(`input[data-item='${JSON.stringify(item)}']`);
                    if (input.length) {
                        const quantity = parseInt(input.val()) || 0;
                        const price = parseInt(input.data('price'));
                        if (quantity > 0) {
                            const itemTotal = quantity * price;
                            total += itemTotal;

                            // Add to WhatsApp message
                            message += `Item: *${item.name}*\nQuantity: *${quantity}*\nTotal: *${formatNumber(itemTotal)}* Gems\n\n`;

                            const row = `
                                <tr>
                                    <td><img src="${item.image}" alt="${item.name}" class="img-thumbnail" style="width: 50px; height: 50px;"></td>
                                    <td>${item.name}</td>
                                    <td>${formatNumber(item.price)} Gems</td>
                                    <td>${quantity}</td>
                                    <td>${formatNumber(itemTotal)} Gems</td>
                                </tr>
                            `;
                            summaryTableBody.append(row);

                            // Floating summary
                            const floatingRow = `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${formatNumber(item.price)} Gems</td>
                                    <td>${quantity}</td>
                                    <td>${formatNumber(itemTotal)} Gems</td>
                                </tr>
                            `;
                            floatingSummaryTableBody.append(floatingRow);
                        }
                    }
                });

                totalGemsElement.text(formatNumber(total));

                // Update WhatsApp button
                const whatsappUrl = `https://wa.me/6282211219993?text=${encodeURIComponent(message)}%0A%0ATotal%20Gems:%20*${formatNumber(total)}*%20Gems`;
                whatsappButtonDiv.html(`<a href="${whatsappUrl}" target="_blank" class="btn btn-success">Beli via WhatsApp</a>`);
            }

            // Fetch data
            $.ajax({
                url: 'data.php',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    data = response;
                    dataLoaded = true;
                    initialize();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('AJAX Error:', textStatus, errorThrown);
                }
            });
        });
    </script>
</body>
</html>
